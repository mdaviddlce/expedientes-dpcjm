{% extends "layout.html" %}
{% block content %}

<section class="panel glass">
  <div class="panel__head">
    <div>
      <h2>EXPEDIENTES</h2>
      <p class="muted">
        LISTADO GENERAL · <span id="countLabel">{{ rows|length }}</span> REGISTRO(S)
      </p>
    </div>

    <div class="row">
      <form id="zipForm" method="post" action="{{ url_for('expedientes_zip') }}" class="inline">
        <button class="btn btn--ghost" type="submit">DESCARGAR PDFS</button>
      </form>

      {% if session.get("role") in ["CAPTURA","ADMINISTRADOR"] %}
        <a class="btn" href="{{ url_for('expediente_new') }}">+ NUEVO EXPEDIENTE</a>
      {% endif %}
    </div>
  </div>

  <!-- Toolbar -->
  <form id="filters" class="toolbar" method="get" action="{{ url_for('index') }}">
    <div class="field">
      <label>BUSCAR</label>
      <input id="q" name="q"
             placeholder="EXPEDIENTE, INMUEBLE, REPRESENTANTE, APODERADOS, TELEFONO..."
             value="{{ request.args.get('q','') }}">
    </div>

    <div class="field">
      <label>AÑO</label>
      <select id="year" name="year">
        <option value="">TODOS</option>
        {% for y in years %}
          <option value="{{ y }}" {% if request.args.get('year')==y %}selected{% endif %}>{{ y }}</option>
        {% endfor %}
      </select>
    </div>

    <div class="field">
      <label>ORDEN</label>
      <select id="sort" name="sort">
        <option value="desc" {% if request.args.get('sort','desc')=='desc' %}selected{% endif %}>
          DESCENDENTE
        </option>
        <option value="asc" {% if request.args.get('sort')=='asc' %}selected{% endif %}>
          ASCENDENTE
        </option>
      </select>
    </div>

    <div class="actions">
      <button class="btn" type="submit">APLICAR</button>
      <a class="btn btn--ghost" href="{{ url_for('index') }}">LIMPIAR</a>
    </div>
  </form>

  <div class="table-wrap">
    <table class="table" id="expTable">
      <thead>
        <tr>
          <th class="center"><input type="checkbox" id="selectAll"></th>
          <th>EXPEDIENTE</th>
          <th>INMUEBLE</th>
          <th>REPRESENTANTE</th>
          <th>APODERADOS</th>
          <th>ARCHIVO FISICO</th>
          <th class="center">AVISOS</th>
          <th class="right">ACCIONES</th>
        </tr>
      </thead>

      <tbody id="expBody">
        {% for r in rows %}
          {% set v = (r["verificaciones"] or 0)|int %}
          {% set sev = "ok" if v <= 1 else ("warn" if v == 2 else "bad") %}

          {# año de created_at (para filtro) #}
          {% set y = (r["created_at"] or "")[:4] %}

          {# para buscar en front si hiciera falta #}
          {% set search = (
              (r["expediente_code"] or "") ~ " " ~
              (r["inmueble_nombre"] or "") ~ " " ~
              (r["representante_legal"] or "") ~ " " ~
              (r["apoderados"] or "") ~ " " ~
              (r["telefono"] or "") ~ " " ~
              (r["domicilio_inspeccion"] or "")
            )|lower
          %}

          {# Orden por número: extrae 0001 (posición 0..3) y MMYY (pos 5..8) de 0001/0126/DPCJM #}
          {% set code = (r["expediente_code"] or "") %}
          {% set num4 = code[:4] %}
          {% set mmyy = code[5:9] %}
          {% set mm = mmyy[:2] %}
          {% set yy = mmyy[2:4] %}

          <tr class="rowExp"
              data-year="{{ y }}"
              data-search="{{ search|e }}"
              data-num="{{ num4 }}"
              data-mm="{{ mm }}"
              data-yy="{{ yy }}">
            <td class="center">
              <input type="checkbox" name="expediente_ids" value="{{ r['id'] }}" form="zipForm">
            </td>

            <td class="mono">{{ r["expediente_code"] }}</td>
            <td>{{ r["inmueble_nombre"] }}</td>
            <td>{{ r["representante_legal"] or "—" }}</td>
            <td>{{ r["apoderados"] or "—" }}</td>
            <td>{{ r["archivo_fisico"] or "—" }}</td>

            <td class="center">
              <div class="avisos-control" data-id="{{ r['id'] }}">
                <span class="badge badge--{{ sev }} aviso-badge">{{ v }}</span>

                {% if session.get("role") in ["CAPTURA","ADMINISTRADOR"] %}
                  <button type="button" class="btn btn--chip btn-avisos" data-action="dec" title="Disminuir">−</button>
                  <button type="button" class="btn btn--chip btn-avisos" data-action="inc" title="Aumentar">+</button>
                {% endif %}
              </div>
            </td>

            <td class="right">
            <a class="btn btn--sm" href="{{ url_for('expediente_view', expediente_id=r['id']) }}">
                ABRIR
            </a>
            </td>
          </tr>
        {% endfor %}

        {% if rows|length == 0 %}
          <tr><td colspan="8" class="muted center">SIN REGISTROS.</td></tr>
        {% endif %}
      </tbody>
    </table>
  </div>
</section>

<script>
  // Select all para ZIP
  const selectAll = document.getElementById("selectAll");
  if (selectAll) {
    selectAll.addEventListener("change", () => {
      document.querySelectorAll('input[name="expediente_ids"]').forEach(cb => {
        cb.checked = selectAll.checked;
      });
    });
  }

  // Orden en el FRONT por código (YY, MM, NNNN) para mostrar “por número”
  // NOTA: esto solo controla la presentación. Tu BD puede quedarse ordenada como sea.
  (function(){
    const params = new URLSearchParams(window.location.search);
    const sort = (params.get("sort") || "desc").trim(); // asc|desc

    const tbody = document.getElementById("expBody");
    const rows = Array.from(document.querySelectorAll(".rowExp"));

    const toInt = (s) => {
      const n = parseInt(s, 10);
      return Number.isFinite(n) ? n : 0;
    };

    rows.sort((a,b) => {
      // clave: YY, luego MM, luego NNNN
      const ayy = toInt(a.dataset.yy);
      const byy = toInt(b.dataset.yy);
      if (ayy !== byy) return (sort === "asc") ? (ayy - byy) : (byy - ayy);

      const amm = toInt(a.dataset.mm);
      const bmm = toInt(b.dataset.mm);
      if (amm !== bmm) return (sort === "asc") ? (amm - bmm) : (bmm - amm);

      const anum = toInt(a.dataset.num);
      const bnum = toInt(b.dataset.num);
      if (anum !== bnum) return (sort === "asc") ? (anum - bnum) : (bnum - anum);

      return 0;
    });

    rows.forEach(r => tbody.appendChild(r));
  })();
</script>

{% endblock %}