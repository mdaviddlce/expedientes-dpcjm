{% extends "layout.html" %}
{% block content %}

<section class="panel glass">
  <div class="panel__head">
    <div>
      <h2>EXPEDIENTES</h2>
      <p class="muted">
        LISTADO GENERAL ¬∑ <span id="countLabel">{{ rows|length }}</span> REGISTRO(S)
      </p>
    </div>

    <div class="row">
      <form id="bulkForm" method="post" class="inline icon-actions">
        <button class="btn btn--icon"
                type="submit"
                formaction="{{ url_for('expedientes_zip') }}"
                title="Descargar PDFs seleccionados">
          üìÑ
        </button>

        <button class="btn btn--icon"
                type="submit"
                formaction="{{ url_for('expedientes_lista') }}"
                title="Descargar lista (Excel)">
          üìã
        </button>
      </form>

      {% if session.get("role") in ["CAPTURA","ADMINISTRADOR"] %}
        <a class="btn btn--icon"
          href="{{ url_for('expediente_new') }}"
          title="NUEVO EXPEDIENTE"
          aria-label="Nuevo expediente">
          ‚ûï
        </a>
      {% endif %}
    </div>
  </div>

  <!-- Toolbar -->
  <form id="filters" class="toolbar" method="get" action="{{ url_for('index') }}">
    <div class="field">
      <label>BUSCAR</label>
      <input id="q" name="q"
             placeholder="EXPEDIENTE, INMUEBLE, REPRESENTANTE, APODERADOS, TELEFONO..."
             value="{{ request.args.get('q','') }}">
    </div>

    <div class="field">
      <label>A√ëO</label>
      <select id="year" name="year">
        <option value="">TODOS</option>
        {% for y in years %}
          <option value="{{ y }}" {% if request.args.get('year')==y %}selected{% endif %}>{{ y }}</option>
        {% endfor %}
      </select>
    </div>

    <div class="field">
      <label>ORDEN</label>
      <select id="sort" name="sort">
        <option value="desc" {% if request.args.get('sort','desc')=='desc' %}selected{% endif %}>
          DESCENDENTE
        </option>
        <option value="asc" {% if request.args.get('sort')=='asc' %}selected{% endif %}>
          ASCENDENTE
        </option>
      </select>
    </div>

    <div class="actions">
      <!-- APLICAR -->
      <button class="btn btn--icon"
              type="submit"
              title="APLICAR FILTROS"
              aria-label="Aplicar filtros">
        üîç
      </button>

      <!-- LIMPIAR -->
      <a class="btn btn--icon"
        href="{{ url_for('index') }}"
        title="LIMPIAR FILTROS"
        aria-label="Limpiar filtros">
        üßπ
      </a>
    </div>
  </form>

  <div class="table-wrap">
    <table class="table" id="expTable">
      <thead>
        <tr>
          <th class="center"><input type="checkbox" id="selectAll"></th>
          <th>EXPEDIENTE</th>
          <th>INMUEBLE</th>
          <th>REPRESENTANTE</th>
          <th>APODERADOS</th>
          <th>ARCHIVO FISICO</th>
          <th class="center">AVISOS</th>
          <th class="right">ACCIONES</th>
        </tr>
      </thead>

      <tbody id="expBody">
        {% for r in rows %}
          {% set v = (r["verificaciones"] or 0)|int %}
          {% set sev = "ok" if v <= 1 else ("warn" if v == 2 else "bad") %}

          {% set y = (r["created_at"] or "")[:4] %}

          {% set search = (
              (r["expediente_code"] or "") ~ " " ~
              (r["inmueble_nombre"] or "") ~ " " ~
              (r["representante_legal"] or "") ~ " " ~
              (r["apoderados"] or "") ~ " " ~
              (r["telefono"] or "") ~ " " ~
              (r["domicilio_inspeccion"] or "")
            )|lower
          %}

          {% set code = (r["expediente_code"] or "") %}
          {% set num4 = code[:4] %}
          {% set mmyy = code[5:9] %}
          {% set mm = mmyy[:2] %}
          {% set yy = mmyy[2:4] %}

          <tr class="rowExp"
              data-year="{{ y }}"
              data-search="{{ search|e }}"
              data-num="{{ num4 }}"
              data-mm="{{ mm }}"
              data-yy="{{ yy }}">
            <td class="center">
              <input type="checkbox" name="expediente_ids" value="{{ r['id'] }}" form="bulkForm">
            </td>

            <td class="mono">{{ r["expediente_code"] }}</td>
            <td>{{ r["inmueble_nombre"] }}</td>
            <td>{{ r["representante_legal"] or "‚Äî" }}</td>
            <td>{{ r["apoderados"] or "‚Äî" }}</td>
            <td>{{ r["archivo_fisico"] or "‚Äî" }}</td>

            <td class="center">
              <div class="avisos-control" data-id="{{ r['id'] }}">
                <span class="badge badge--{{ sev }} aviso-badge">{{ v }}</span>

                {% if session.get("role") in ["CAPTURA","ADMINISTRADOR"] %}
                  <button type="button" class="btn btn--chip btn-avisos" data-action="dec" title="Disminuir">‚àí</button>
                  <button type="button" class="btn btn--chip btn-avisos" data-action="inc" title="Aumentar">+</button>
                {% endif %}
              </div>
            </td>

            <td class="right">
              <a class="btn btn--sm" href="{{ url_for('expediente_view', expediente_id=r['id']) }}">
                ABRIR
              </a>
            </td>
          </tr>
        {% endfor %}

        {% if rows|length == 0 %}
          <tr><td colspan="8" class="muted center">SIN REGISTROS.</td></tr>
        {% endif %}
      </tbody>
    </table>
  </div>
</section>

<!-- FOOTER -->
  <footer class="footer glass">
    <div class="footer__inner">
      ¬© {{ now().year if now else "2026" }}  
      DEPARTAMENTO DE PROTECCION CIVIL ¬∑ JESUS MARIA  
      <span class="sep">‚Ä¢</span>
      TODOS LOS DERECHOS RESERVADOS
    </div>
  </footer>

{% endblock %}